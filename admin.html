<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Logistik - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; color: #333; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { color: #1e88e5; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .info-bar { background-color: #e3f2fd; color: #1e88e5; padding: 10px; border-radius: 5px; margin-bottom: 20px; font-weight: 600; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #1e88e5; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        button { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        .edit-btn { background-color: #ffc107; color: #333; }
        .edit-btn:hover { background-color: #e0a800; }
        .logout-btn { background-color: #d9534f; color: white; float: right; margin-top: -50px; }
        .logout-btn:hover { background-color: #c9302c; }
        /* Modal Styling */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 8px; position: relative; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-btn:hover, .close-btn:focus { color: #000; text-decoration: none; cursor: pointer; }
        /* Status Badges */
        .status-master { background-color: #007bff; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
        .status-sub_admin { background-color: #28a745; color: white; padding: 4px 8px; border-radius: 4px; }
        .status-aktif { background-color: #17a2b8; color: white; padding: 4px 8px; border-radius: 4px; }
        .status-pending { background-color: #ffc107; color: #333; padding: 4px 8px; border-radius: 4px; }
        .status-blokir { background-color: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; }
        #message { /* styling sama seperti di index.html */ }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-user-shield"></i> Admin Panel Pengguna</h1>
        <button class="logout-btn" onclick="logout()">LOGOUT</button>
        <div id="adminInfo" class="info-bar">Memverifikasi akses...</div>
        <div id="message"></div>
        
        <h2>Daftar Pengguna</h2>
        <table>
            <thead>
                <tr>
                    <th>Nama</th>
                    <th>Toko</th>
                    <th>Status</th>
                    <th>Tanggal Daftar</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                <tr><td colspan="5">Memuat Data...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>Ubah Status Pengguna</h3>
            <p>Nama: <span id="modalNama"></span></p>
            <p>Toko: <span id="modalToko"></span></p>
            
            <div class="input-group">
                <label for="newStatus">Status Baru</label>
                <select id="newStatus">
                    <option value="AKTIF">AKTIF</option>
                    <option value="SUB_ADMIN">SUB_ADMIN</option>
                    <option value="PENDING">PENDING</option>
                    <option value="BLOKIR">BLOKIR</option>
                </select>
            </div>
            
            <button onclick="handleUpdateStatus()">Simpan Perubahan</button>
        </div>
    </div>

    <script>
        // --- PENTING: GANTI DENGAN URL APPS SCRIPT ANDA ---
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwOVmbAtdQZtNCRXdxsYMnvCQmuCp_BzMLsIzIRmeLmyAUrrsgihDi2Efv4En0N542ZnQ/exec'; 
        // --- AKHIR PENTING ---

        const USER_TABLE_BODY = document.getElementById('userTableBody');
        const MESSAGE_ELEMENT = document.getElementById('message');
        let currentUserSession = null;
        let usersToUpdate = []; // Array untuk menyimpan perubahan status yang akan dikirim

        // --- (Fungsi displayMessage - SALIN DARI index.html) ---
        function displayMessage(text, type = 'error') {
            MESSAGE_ELEMENT.textContent = text;
            MESSAGE.ELEMENT.classList.remove('show', 'error', 'loading', 'success');
            
            MESSAGE_ELEMENT.classList.add(type);

            setTimeout(() => {
                MESSAGE_ELEMENT.classList.add('show');
            }, 10); 

            if (type !== 'loading') {
                setTimeout(() => {
                    MESSAGE_ELEMENT.classList.remove('show');
                }, 7000);
            }
        }
        
        // --- FUNGSI API REQUEST (ANTI-CORS: Menggunakan form-urlencoded) ---
        async function sendApiRequest(action, data = {}, method = 'POST') {
            const payload = { action, ...data };
            const body = new URLSearchParams(payload).toString(); 
            
            let targetUrl = GAS_API_URL;
            const options = {
                method: method,
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, 
            };
            
            if (method === 'POST') {
                options.body = body;
            } else if (method === 'GET') {
                const searchParams = new URLSearchParams(payload);
                targetUrl += '?' + searchParams.toString();
                delete options.body; 
                delete options.headers; 
            }

            const response = await fetch(targetUrl, options);
            const responseText = await response.text();
            
            try {
                const responseData = JSON.parse(responseText);
                if (responseData.status === 'error') {
                    console.error("Error Log dari Apps Script:", responseData.message); 
                    throw new Error(responseData.message); 
                }
                return responseData;
            } catch (e) {
                 console.error("Gagal Parse JSON atau Kesalahan Jaringan:", responseText, e); 
                 if (e.message && e.message.includes('Akses ditolak')) {
                     throw e; 
                 }
                 throw new Error('Gagal berkomunikasi dengan server. Cek koneksi atau URL Apps Script.');
            }
        }
        // --- END sendApiRequest ---

        function checkAdminAccess() {
            const session = localStorage.getItem('userSession');
            if (!session) {
                window.location.href = './index.html';
                return false;
            }
            currentUserSession = JSON.parse(session);
            
            const isAdmin = currentUserSession.status === 'MASTER' || currentUserSession.status === 'SUB_ADMIN';
            
            if (!isAdmin) {
                displayMessage('❌ Akses Ditolak: Anda bukan Admin.', 'error');
                setTimeout(() => window.location.href = './main.html', 3000);
                return false;
            }
            
            document.getElementById('adminInfo').textContent = 
                `Anda Login sebagai: ${currentUserSession.nama} (${currentUserSession.status}) di Toko ${currentUserSession.toko}`;
            
            return true;
        }

        function logout() {
            localStorage.removeItem('userSession');
            window.location.href = './index.html';
        }

        async function loadUserList() {
            if (!checkAdminAccess()) return;

            USER_TABLE_BODY.innerHTML = '<tr><td colspan="5">⏳ Memuat data pengguna...</td></tr>';
            
            try {
                // Kirim status dan toko pengguna yang meminta ke Apps Script
                const data = {
                    action: 'getAdminUsers',
                    userStatus: currentUserSession.status,
                    userToko: currentUserSession.toko
                };

                const response = await sendApiRequest('getAdminUsers', data, 'POST'); 
                const users = response.users || [];
                
                renderUserTable(users);
                
            } catch (error) {
                displayMessage('❌ Gagal memuat daftar pengguna: ' + error.message, 'error');
                USER_TABLE_BODY.innerHTML = '<tr><td colspan="5">❌ Gagal memuat data.</td></tr>';
            }
        }

        function renderUserTable(users) {
            USER_TABLE_BODY.innerHTML = '';
            if (users.length === 0) {
                USER_TABLE_BODY.innerHTML = '<tr><td colspan="5">Tidak ada pengguna yang terdaftar di area Anda.</td></tr>';
                return;
            }

            const isAdminMaster = currentUserSession.status === 'MASTER';

            users.forEach(user => {
                let actionsHtml = '';
                
                // PENTING: Logika Hirarki Display
                if (user.status === 'MASTER') {
                    // Hanya Master Admin yang bisa melihat baris Master (walau backend sudah filter)
                    actionsHtml = `<span>Master Admin Tertinggi</span>`;
                    // Jika Sub Admin bisa melihat (kebocoran), dia tidak akan bisa mengedit
                } else {
                    // Semua pengguna lain dapat di-edit
                    actionsHtml = `
                        <button class="edit-btn" 
                            onclick="openEditModal('${user.nama}', '${user.toko}', '${user.status}')">
                            <i class="fas fa-edit"></i> Ubah Status
                        </button>
                    `;
                }

                const row = `
                    <tr>
                        <td>${user.nama}</td>
                        <td>${user.toko}</td>
                        <td><span class="status-${user.status.toLowerCase().replace('_', '-')}">${user.status}</span></td>
                        <td>${user.tanggal}</td>
                        <td>${actionsHtml}</td>
                    </tr>
                `;
                USER_TABLE_BODY.insertAdjacentHTML('beforeend', row);
            });
        }
        
        function openEditModal(nama, toko, status) {
            document.getElementById('modalNama').textContent = nama;
            document.getElementById('modalToko').textContent = toko;
            document.getElementById('newStatus').value = status;
            document.getElementById('editModal').style.display = 'block';

            // Bersihkan atau inisialisasi array update hanya saat modal dibuka
            usersToUpdate = [];
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        
        async function handleUpdateStatus() {
            const nama = document.getElementById('modalNama').textContent;
            const toko = document.getElementById('modalToko').textContent;
            const newStatus = document.getElementById('newStatus').value;

            // Tambahkan ke array update
            usersToUpdate.push({ nama, toko, newStatus });

            displayMessage('⏳ Menyimpan perubahan status...', 'loading');
            closeModal();
            
            try {
                const data = {
                    action: 'updateUserStatus',
                    updates: JSON.stringify(usersToUpdate),
                    tokoAdmin: currentUserSession.toko,
                    isAdminMaster: currentUserSession.status === 'MASTER' ? 'true' : 'false'
                };

                const response = await sendApiRequest('updateUserStatus', data, 'POST');
                
                displayMessage(`✅ ${response.message}`, 'success');
                usersToUpdate = []; // Kosongkan array setelah berhasil
                loadUserList(); // Muat ulang daftar
                
            } catch (error) {
                displayMessage(`❌ Gagal menyimpan status: ${error.message}`, 'error');
                // Biarkan usersToUpdate tetap ada jika Anda ingin mencoba lagi, atau reset:
                usersToUpdate = []; 
                loadUserList(); // Muat ulang untuk mendapatkan status asli
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            if (checkAdminAccess()) {
                loadUserList();
            }
        });
    </script>
</body>
</html>
