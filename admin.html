<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMART SWALAYAN - PANEL ADMIN</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* CSS yang sama */
        :root { --primary-color: #00796b; --secondary-color: #ff9800; --danger-color: #f44336; --text-color: #333; --bg-color: #eceff1; --card-bg: #ffffff; --border-radius: 12px; --shadow-heavy: 0 10px 30px rgba(0, 0, 0, 0.15); }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--bg-color); display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 20px; color: var(--text-color); }
        .container { background-color: var(--card-bg); padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow-heavy); width: 100%; max-width: 800px; margin-top: 20px; transition: all 0.3s ease; }
        .header-logo { display: block; max-width: 100%; max-height: 70px; margin: 0 auto 20px auto; border-radius: 8px; border: 2px solid var(--primary-color); }
        h1 { text-align: center; color: var(--primary-color); margin-bottom: 25px; font-size: 1.6em; }

        .user-info { background-color: #e0f2f1; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9em; color: var(--primary-color); display: flex; justify-content: space-between; align-items: center; font-weight: 600; }
        .user-info button { background: none; border: none; color: var(--danger-color); font-size: 1.1em; padding: 5px; cursor: pointer; }

        /* Navigasi Admin & Simpan */
        .admin-nav { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 20px; }
        .admin-nav button, #saveChangesButton { 
            padding: 10px 15px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;
        }
        #goToMainButton { background-color: #03a9f4; color: white; } /* Biru muda */
        #goToMainButton:hover { background-color: #0288d1; }
        
        #saveChangesButton {
            width: 100%; padding: 15px 20px; background-color: var(--secondary-color); color: white; margin-top: 20px;
        }
        #saveChangesButton:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Tabel */
        .table-responsive { overflow-x: auto; }
        .user-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        .user-table th, .user-table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .user-table th { background-color: var(--primary-color); color: white; position: sticky; top: 0; }
        .user-table tr:hover { background-color: #f5f5f5; }
        
        .status-select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 1em; width: 100%; max-width: 120px; }

        /* Status Colors */
        .status-select[value="MASTER"] { background-color: #c62828; color: white; font-weight: 700; }
        .status-select[value="SUB_ADMIN"] { background-color: #e65100; color: white; }
        .status-select[value="AKTIF"] { background-color: #388e3c; color: white; }
        .status-select[value="PENDING"] { background-color: #fbc02d; color: black; }
        .status-select[value="DITOLAK"] { background-color: #616161; color: white; }

        /* Messages */
        .message { text-align: center; margin-top: 20px; padding: 12px; border-radius: 8px; font-weight: 600; opacity: 0; transition: opacity 0.5s, transform 0.5s; transform: translateY(10px); }
        .message.success { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .message.error { background-color: #fce4e4; color: #c62828; border-color: #ef9a9a; border: 1px solid; }
        .message.loading { background-color: #fffde7; color: #fbc02d; border-color: #fff9c4; border: 1px solid; }
        .message.show { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>
    <div class="container">
        <img src="smart.jpg" alt="Logo Smart Swalayan" class="header-logo">
        <h1><i class="fas fa-user-shield"></i> PANEL ADMINISTRASI PENGGUNA</h1>

        <div class="user-info">
            <span id="userInfoText"><i class="fas fa-user-circle"></i> Memuat Sesi...</span>
            <button id="logoutButton" title="Keluar"><i class="fas fa-sign-out-alt"></i></button>
        </div>
        
        <div class="admin-nav">
             <button id="goToMainButton"><i class="fas fa-home"></i> Ke Halaman Transaksi</button>
        </div>

        <div class="table-responsive">
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Nama</th>
                        <th>Toko</th>
                        <th>Status Akses</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <tr><td colspan="3" style="text-align: center;">Memuat data pengguna...</td></tr>
                </tbody>
            </table>
        </div>

        <button id="saveChangesButton" disabled><i class="fas fa-save"></i> SIMPAN PERUBAHAN</button>
        <p id="message" class="message"></p>
    </div>

<script>
    // --- PENTING: GANTI DENGAN URL APPS SCRIPT ANDA ---
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbw0kA0Go-xS0jboNcuWVjUIEuBwk9UmhkymfYxLPPqR-mcu8XliS8S08Ao5aCbt_LEdog/exec'; 
    // --- AKHIR PENTING ---

    const USER_TABLE_BODY = document.getElementById('userTableBody');
    const MESSAGE_ELEMENT = document.getElementById('message');
    let currentUserSession = null;

    // ... (Fungsi displayMessage dan sendApiRequest - SALIN DARI index.html) ...
    // Pastikan sendApiRequest menggunakan let targetUrl untuk GET.

    function checkAdminAccess() {
        const session = localStorage.getItem('userSession');
        if (!session) {
            window.location.href = './index.html'; // Belum login
            return false;
        }
        currentUserSession = JSON.parse(session);
        
        if (currentUserSession.status !== 'MASTER' && currentUserSession.status !== 'SUB_ADMIN') {
            displayMessage('❌ Akses Ditolak: Anda tidak memiliki hak Admin.', 'error');
            setTimeout(() => window.location.href = './main.html', 3000);
            return false;
        }
        
        // Tampilkan info sesi di UI
        document.getElementById('adminInfo').textContent = 
            `Anda Login sebagai: ${currentUserSession.nama} (${currentUserSession.status}) di Toko ${currentUserSession.toko}`;
        
        return true;
    }

    async function loadUserList() {
        if (!checkAdminAccess()) return;

        USER_TABLE_BODY.innerHTML = '<tr><td colspan="4">⏳ Memuat data pengguna...</td></tr>';
        
        try {
            // Kirim status dan toko pengguna yang meminta ke Apps Script
            const data = {
                action: 'getAdminUsers',
                userStatus: currentUserSession.status,
                userToko: currentUserSession.toko
            };

            const response = await sendApiRequest('getAdminUsers', data, 'POST'); 
            const users = response.users || [];
            
            renderUserTable(users);
            
        } catch (error) {
            displayMessage('❌ Gagal memuat daftar pengguna: ' + error.message, 'error');
            USER_TABLE_BODY.innerHTML = '<tr><td colspan="4">❌ Gagal memuat data.</td></tr>';
        }
    }

    function renderUserTable(users) {
        USER_TABLE_BODY.innerHTML = '';
        if (users.length === 0) {
            USER_TABLE_BODY.innerHTML = '<tr><td colspan="4">Tidak ada pengguna yang terdaftar di area Anda.</td></tr>';
            return;
        }

        users.forEach(user => {
            let actionsHtml = '';
            
            // Logika Frontend: Hanya tampilkan tombol Aksi untuk status non-MASTER
            // Master Admin dapat melihat semua (karena backend mengirimkannya), 
            // tetapi hanya dapat mengedit yang statusnya di bawah mereka.
            
            if (user.status === 'MASTER') {
                actionsHtml = `<span>Master Admin Tertinggi</span>`;
            } else {
                // Semua pengguna lain dapat di-edit oleh Master dan Sub Admin 
                // (karena Sub Admin HANYA melihat pengguna toko mereka)
                actionsHtml = `
                    <button class="edit-btn" onclick="openEditModal('${user.nama}', '${user.toko}', '${user.status}')">
                        <i class="fas fa-edit"></i> Ubah Status
                    </button>
                `;
            }

            const row = `
                <tr>
                    <td>${user.nama}</td>
                    <td>${user.toko}</td>
                    <td><span class="status-${user.status.toLowerCase()}">${user.status}</span></td>
                    <td>${actionsHtml}</td>
                </tr>
            `;
            USER_TABLE_BODY.insertAdjacentHTML('beforeend', row);
        });
    }

    // ... (Fungsi openEditModal dan handleUpdateStatus akan diletakkan di sini) ...
    // Di dalam handleUpdateStatus, Anda harus memvalidasi lagi di frontend 
    // agar MASTER ADMIN tidak dapat diubah (meskipun backend sudah melindungi)
    
    document.addEventListener('DOMContentLoaded', () => {
        loadUserList();
    });
</script>
</body>
</html>
